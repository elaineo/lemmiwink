{% extends "base/app.html" %}
{% block content %}

    <div id="homepage_content" data-role="content">
      <div class="page-subtitle">
        Where do you want to send your items?
      </div>
      <button class='ui-mini ui-btn' id='contactsBtn' disabled>SELECT FROM CONTACTS</button>
      <div id='recent' style='padding:10px;'>
      <table id='recTable'>
        <tr><td>RECENT</td></tr>
      <tr onclick='selectAddr("1234")'><td>Elaine Ou<br>6936 Ferncroft</td></tr>
      </table>
      <button class='ui-mini ui-btn' id='addnewBtn'>ADD NEW</button>
      </div>
      <form enctype="multipart/form-data" method="post" id="filladdr_form" class="form-horizontal">
        <input type="text" class='input-address' name="name" placeholder="Recipients name">
        <hr class='input-hr'>
        <input type="text" class='input-address' name="address" placeholder="Address">
        <hr class='input-hr'>
        <input type="text" class='input-address' name="apt" placeholder="Apt / suite / unit">
        <hr class='input-hr'>
        <input type="text" class='input-address' name="city" placeholder="City">
        <hr class='input-hr'>
        <input type="text" class='input-address' name="state" placeholder="State">
        <hr class='input-hr'>
        <input type="text" class='input-address' name="zip" placeholder="Zip">
        <button class='ui-mini ui-btn' id='addr_btn' disabled>DONE</button>
      </form>

    </div><!-- /page -->
<script type="text/javascript" charset="utf-8">
function initialize() {
  $('#addr_btn').removeAttr('disabled');
}
</script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&libraries=places&callback=initialize"></script>
<script type="text/javascript" charset="utf-8" src="js/validation.js"></script>
<script type="text/javascript" charset="utf-8" src="js/data/urls.js"></script>
<script type="text/javascript" charset="utf-8" src="js/cookie.js"></script>
<script type="text/javascript" charset="utf-8">

document.addEventListener("deviceready", onDeviceReady, false);
/* check for recent contacts */
function onDeviceReady() {
  console.log('Ready');
  var cookie = getUserCookie();
  data = {'userkey':cookie, 'type': 1};
  console.log(cookie);
    $.ajax({
        type: "POST",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        url: wwwHome + "/mobile/get_addr",
        data: JSON.stringify(data),
        success: function(response) {
          console.log(response);
          if (response.status == "ok") {
            $('form#filladdr_form').hide();
            $('#recent').show();
            var adump = '';
            for (a in response.addrs) {
              adump = '<tr onclick=\'selectAddr("' + response.addrs[a].addrkey + '")\'><td>'+response.addrs[a].name + '<br>' + response.addrs[a].street + '</td></tr>';
              $('#recTable tr:last').after(adump);
            }
          } else {
            $('#recent').hide();
            $('form#filladdr_form').show();
          }
        }
    });
}

/* Select from recent contacts, save to local store */
function selectAddr(address) {
  window.localStorage.setItem("destination", address);
}
/* send address info to server */
function validate_addr() {
  var $form = $('#filladdr_form');
  var name = $form.find('input[name=name]').val();
  var address = $form.find('input[name=address]').val();
  var city = $form.find('input[name=city]').val();
  var state = $form.find('input[name=state]').val();
  var zip = $form.find('input[name=zip]').val();
  if (name!=='' && address!=='' && city!=='' && state!=='' && zip!=='')
    return true;
  else
    return false;
}
$('#addr_btn').click( function(e) {
  e.preventDefault();

  var valid = validate_addr();
  if (!valid) {
    alert('Incomplete Address');
    return
  }
  // Try to get a geopt for this address
  var data = $('#filladdr_form').serializeObject();
  data.userkey = getUserCookie();
  geoFunc(data);
});

function geoFuncCallback(data) {
  $.ajax({
    type: "POST",
    dataType: "json",
    contentType: "application/json; charset=utf-8",
    url: wwwHome + "/mobile/create_addr",
    data: JSON.stringify(data),
    success: function(response) {
      console.log(JSON.stringify(response));
      if (response.status == "ok") {
          window.localStorage.setItem("destination", response.addrkey);
          $.mobile.changePage('photo.html');
      } else {
         alert('Error');
      }
    }
  });
}
</script>
{% endblock %}

